import{isServer as v,getRequestEvent as P}from"solid-js/web";import{provideRequestEvent as He}from"solid-js/web/storage";import{H3Event as K,sendRedirect as Te,getCookie as $e,setCookie as Le,deleteCookie as qe,setResponseStatus as ke,setHeader as Ie,getRequestIP as Fe,getResponseStatus as je,getResponseStatusText as Ue,getRequestURL as We,getResponseHeaders as Be,getResponseHeader as Me,setResponseHeader as De,appendResponseHeader as Ke,removeResponseHeader as Ne,getRequestWebStream as Xe}from"h3";import{AsyncLocalStorage as ze}from"node:async_hooks";import{getOwner as z,runWithOwner as ue,createMemo as E,createContext as le,useContext as fe,createSignal as _,createRenderEffect as Ge,untrack as ee,on as Je,startTransition as T,resetErrorBoundaries as te,createComponent as Qe,getListener as Ve,onCleanup as he,sharedConfig as A,$TRACK as Ye}from"solid-js";function Ze(){let e=new Set;function t(r){return e.add(r),()=>e.delete(r)}let n=!1;function o(r,a){if(n)return!(n=!1);const s={to:r,options:a,defaultPrevented:!1,preventDefault:()=>s.defaultPrevented=!0};for(const c of e)c.listener({...s,from:c.location,retry:u=>{u&&(n=!0),c.navigate(r,{...a,resolve:!1})}});return!s.defaultPrevented}return{subscribe:t,confirm:o}}let N;function de(){(!window.history.state||window.history.state._depth==null)&&window.history.replaceState({...window.history.state,_depth:window.history.length-1},""),N=window.history.state._depth}v||de();function on(e){return{...e,_depth:window.history.state&&window.history.state._depth}}function sn(e,t){let n=!1;return()=>{const o=N;de();const r=o==null?null:N-o;if(n){n=!1;return}r&&t(r)?(n=!0,window.history.go(-r)):e()}}const et=/^(?:[a-z0-9]+:)?\/\//i,tt=/^\/+|(\/)\/+$/g,pe="http://sr";function $(e,t=!1){const n=e.replace(tt,"$1");return n?t||/^[?#]/.test(n)?n:"/"+n:""}function F(e,t,n){if(et.test(t))return;const o=$(e),r=n&&$(n);let a="";return!r||t.startsWith("/")?a=o:r.toLowerCase().indexOf(o.toLowerCase())!==0?a=o+r:a=r,(a||"/")+$(t,!a)}function nt(e,t){if(e==null)throw new Error(t);return e}function rt(e,t){return $(e).replace(/\/*(\*.*)?$/g,"")+$(t)}function ge(e){const t={};return e.searchParams.forEach((n,o)=>{t[o]=n}),t}function ot(e,t,n){const[o,r]=e.split("/*",2),a=o.split("/").filter(Boolean),s=a.length;return c=>{const u=c.split("/").filter(Boolean),l=u.length-s;if(l<0||l>0&&r===void 0&&!t)return null;const i={path:s?"":"/",params:{}},g=h=>n===void 0?void 0:n[h];for(let h=0;h<s;h++){const p=a[h],f=u[h],y=p[0]===":",w=y?p.slice(1):p;if(y&&M(f,g(w)))i.params[w]=f;else if(y||!M(f,p))return null;i.path+=`/${f}`}if(r){const h=l?u.slice(-l).join("/"):"";if(M(h,g(r)))i.params[r]=h;else return null}return i}}function M(e,t){const n=o=>o.localeCompare(e,void 0,{sensitivity:"base"})===0;return t===void 0?!0:typeof t=="string"?n(t):typeof t=="function"?t(e):Array.isArray(t)?t.some(n):t instanceof RegExp?t.test(e):!1}function st(e){const[t,n]=e.pattern.split("/*",2),o=t.split("/").filter(Boolean);return o.reduce((r,a)=>r+(a.startsWith(":")?2:3),o.length-(n===void 0?0:1))}function at(e){const t=new Map,n=z();return new Proxy({},{get(o,r){return t.has(r)||ue(n,()=>t.set(r,E(()=>e()[r]))),t.get(r)()},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},ownKeys(){return Reflect.ownKeys(e())}})}function ye(e){let t=/(\/?\:[^\/]+)\?/.exec(e);if(!t)return[e];let n=e.slice(0,t.index),o=e.slice(t.index+t[0].length);const r=[n,n+=t[1]];for(;t=/^(\/\:[^\/]+)\?/.exec(o);)r.push(n+=t[1]),o=o.slice(t[0].length);return ye(o).reduce((a,s)=>[...a,...r.map(c=>c+s)],[])}const it=100,ct=le(),ut=le(),me=()=>nt(fe(ct),"<A> and 'use' router primitives can be only used inside a Route."),lt=()=>me().navigatorFactory();function ft(e,t=""){const{component:n,load:o,children:r,info:a}=e,s=!r||Array.isArray(r)&&!r.length,c={key:e,component:n,load:o,info:a};return we(e.path).reduce((u,l)=>{for(const i of ye(l)){const g=rt(t,i);let h=s?g:g.split("/*",1)[0];h=h.split("/").map(p=>p.startsWith(":")||p.startsWith("*")?p:encodeURIComponent(p)).join("/"),u.push({...c,originalPath:i,pattern:h,matcher:ot(h,!s,e.matchFilters)})}return u},[])}function ht(e,t=0){return{routes:e,score:st(e[e.length-1])*1e4-t,matcher(n){const o=[];for(let r=e.length-1;r>=0;r--){const a=e[r],s=a.matcher(n);if(!s)return null;o.unshift({...s,route:a})}return o}}}function we(e){return Array.isArray(e)?e:[e]}function dt(e,t="",n=[],o=[]){const r=we(e);for(let a=0,s=r.length;a<s;a++){const c=r[a];if(c&&typeof c=="object"){c.hasOwnProperty("path")||(c.path="");const u=ft(c,t);for(const l of u){n.push(l);const i=Array.isArray(c.children)&&c.children.length===0;if(c.children&&!i)dt(c.children,l.pattern,n,o);else{const g=ht([...n],o.length);o.push(g)}n.pop()}}}return n.length?o:o.sort((a,s)=>s.score-a.score)}function pt(e,t){for(let n=0,o=e.length;n<o;n++){const r=e[n].matcher(t);if(r)return r}return[]}function gt(e,t){const n=new URL(pe),o=E(u=>{const l=e();try{return new URL(l,n)}catch{return console.error(`Invalid path ${l}`),u}},n,{equals:(u,l)=>u.href===l.href}),r=E(()=>o().pathname),a=E(()=>o().search,!0),s=E(()=>o().hash),c=()=>"";return{get pathname(){return r()},get search(){return a()},get hash(){return s()},get state(){return t()},get key(){return c()},query:at(Je(a,()=>ge(o())))}}let S;function yt(){return S}function an(e,t,n,o={}){const{signal:[r,a],utils:s={}}=e,c=s.parsePath||(d=>d),u=s.renderPath||(d=>d),l=s.beforeLeave||Ze(),i=F("",o.base||"");if(i===void 0)throw new Error(`${i} is not a valid base path`);i&&!r().value&&a({value:i,replace:!0,scroll:!1});const[g,h]=_(!1),p=async d=>{h(!0);try{await T(d)}finally{h(!1)}},[f,y]=_(r().value),[w,V]=_(r().state),Ce=gt(f,w),H=[],W=_(v?Oe():[]),Y={pattern:i,params:{},path:()=>i,outlet:()=>null,resolvePath(d){return F(i,d)}};return Ge(()=>{const{value:d,state:m}=r();ee(()=>{d!==f()&&p(()=>{S="native",y(d),V(m),te(),W[1]([])}).then(()=>{S=void 0})})}),{base:Y,location:Ce,isRouting:g,renderPath:u,parsePath:c,navigatorFactory:Ee,beforeLeave:l,preloadRoute:Pe,singleFlight:o.singleFlight===void 0?!0:o.singleFlight,submissions:W};function Ae(d,m,x){ee(()=>{if(typeof m=="number"){m&&(s.go?s.go(m):console.warn("Router integration does not support relative routing"));return}const{replace:q,resolve:B,scroll:C,state:O}={replace:!1,resolve:!0,scroll:!0,...x},b=B?d.resolvePath(m):F("",m);if(b===void 0)throw new Error(`Path '${m}' is not a routable path`);if(H.length>=it)throw new Error("Too many redirects");const Z=f();if(b!==Z||O!==w()){if(v){const k=P();k&&(k.response={status:302,headers:new Headers({Location:b})}),a({value:b,replace:q,scroll:C,state:O})}else if(l.confirm(b,x)){const k=H.push({value:Z,replace:q,scroll:C,state:w()});p(()=>{S="navigate",y(b),V(O),te(),W[1]([])}).then(()=>{H.length===k&&(S=void 0,_e({value:b,state:O}))})}}})}function Ee(d){return d=d||fe(ut)||Y,(m,x)=>Ae(d,m,x)}function _e(d){const m=H[0];m&&((d.value!==m.value||d.state!==m.state)&&a({...d,replace:m.replace,scroll:m.scroll}),H.length=0)}function Pe(d,m){const x=pt(n(),d.pathname),q=S;S="preload";for(let B in x){const{route:C,params:O}=x[B];C.component&&C.component.preload&&C.component.preload();const{load:b}=C;m&&b&&ue(t(),()=>b({params:O,location:{pathname:d.pathname,search:d.search,hash:d.hash,query:ge(d),state:null,key:""},intent:"preload"}))}S=q}function Oe(){const d=P();return d&&d.router&&d.router.submission?[d.router.submission]:[]}}function cn(e,t,n,o,r){const{base:a,location:s}=e,{pattern:c,component:u,load:l}=o().route,i=E(()=>o().path);u&&u.preload&&u.preload();const g=l?l({params:r,location:s,intent:S||"initial"}):void 0;return{parent:t,pattern:c,path:i,params:r,outlet:()=>u?Qe(u,{params:r,location:s,data:g,get children(){return n()}}):n(),resolvePath(p){return F(a.path(),p,i())}}}const mt="Location",wt=5e3,Rt=18e4;let L=new Map;v||setInterval(()=>{const e=Date.now();for(let[t,n]of L.entries())!n[3].count&&e-n[0]>Rt&&L.delete(t)},3e5);function G(){if(!v)return L;const e=P();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function vt(e,t=!0){return T(()=>{const n=Date.now();Re(e,o=>{t&&(o[0]=0),o[3][1](n)})})}function Re(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of L.keys())(e===void 0||bt(n,e))&&t(L.get(n))}function U(e,t){e.GET&&(e=e.GET);const n=(...o)=>{const r=G(),a=yt(),c=z()?lt():void 0,u=Date.now(),l=t+X(o);let i=r.get(l),g;if(v){const f=P();if(f){const y=(f.router||(f.router={})).dataOnly;if(y){const w=f&&(f.router.data||(f.router.data={}));if(w&&l in w)return w[l];if(Array.isArray(y)&&!y.includes(l))return w[l]=void 0,Promise.resolve()}}}if(Ve()&&!v&&(g=!0,he(()=>i[3].count--)),i&&i[0]&&(v||a==="native"||i[3].count||Date.now()-i[0]<wt)){g&&(i[3].count++,i[3][0]()),i[2]==="preload"&&a!=="preload"&&(i[0]=u);let f=i[1];return a!=="preload"&&(f="then"in i[1]?i[1].then(p(!1),p(!0)):p(!1)(i[1]),!v&&a==="navigate"&&T(()=>i[3][1](i[0]))),f}let h=!v&&A.context&&A.has(l)?A.load(l):e(...o);if(i?(i[0]=u,i[1]=h,i[2]=a,!v&&a==="navigate"&&T(()=>i[3][1](i[0]))):(r.set(l,i=[u,h,a,_(u)]),i[3].count=0),g&&(i[3].count++,i[3][0]()),v){const f=P();if(f&&f.router.dataOnly)return f.router.data[l]=h}if(a!=="preload"&&(h="then"in h?h.then(p(!1),p(!0)):p(!1)(h)),v&&A.context&&A.context.async&&!A.context.noHydrate){const f=P();(!f||!f.serverOnly)&&A.context.serialize(l,h)}return h;function p(f){return async y=>{if(y instanceof Response){if(y.headers.has("Location")){c&&T(()=>{let w=y.headers.get(mt);w&&w.startsWith("/")?c(w,{replace:!0}):!v&&w&&(window.location.href=w)});return}y.customBody&&(y=await y.customBody())}if(f)throw y;return y}}};return n.keyFor=(...o)=>t+X(o),n.key=t,n}U.set=(e,t)=>{const n=G(),o=Date.now();let r=n.get(e);r?(r[0]=o,r[1]=t,r[2]="preload"):(n.set(e,r=[o,t,,_(o)]),r[3].count=0)};U.clear=()=>G().clear();function bt(e,t){for(let n of t)if(e.startsWith(n))return!0;return!1}function X(e){return JSON.stringify(e,(t,n)=>St(n)?Object.keys(n).sort().reduce((o,r)=>(o[r]=n[r],o),{}):n)}function St(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const ne=new Map;function xt(e,t){const n=me(),o=E(()=>n.submissions[0]().filter(r=>r.url===e.toString()&&(!t||t(r.input))));return new Proxy([],{get(r,a){return a===Ye?o():a==="pending"?o().some(s=>!s.result):o()[a]}})}function un(e,t){const n=xt(e,t);return new Proxy({},{get(o,r){return n[n.length-1]?.[r]}})}function ve(e,t){function n(...r){const a=this.r,s=this.f,c=(a.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...r),[u,l]=_();let i;function g(h){return async p=>{const f=await At(p,h,a.navigatorFactory());if(!f)return i.clear();if(l(f),f.error&&!s)throw f.error;return f.data}}return a.submissions[1](h=>[...h,i={input:r,url:o,get result(){return u()?.data},get error(){return u()?.error},get pending(){return!u()},clear(){a.submissions[1](p=>p.filter(f=>f.input!==r))},retry(){return l(void 0),e(...r).then(g(),g(!0))}}]),c.then(g(),g(!0))}const o=e.url||t&&`https://action/${t}`||(v?"":`https://action/${Ct(e.toString())}`);return be(n,o)}function be(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const o=function(...a){return e.call(this,...n,...a)},r=new URL(t,pe);return r.searchParams.set("args",X(n)),be(o,(r.origin==="https://action"?r.origin:"")+r.pathname+r.search)},e.url=t,v||(ne.set(t,e),z()&&he(()=>ne.delete(t))),e}const Ct=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function At(e,t,n){let o,r,a;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(r=a=e.headers.get("X-Revalidate").split(",")),e.customBody&&(o=await e.customBody(),e.headers.has("X-Single-Flight")&&(r||(r=[]),a||(a=[]),Object.keys(o).forEach(s=>{s!=="_$value"&&(r.push(s),U.set(s,o[s]))}),o=o._$value)),e.headers.has("Location")){const s=e.headers.get("Location")||"/";s.startsWith("http")?window.location.href=s:n(s)}}else{if(t)return{error:e};o=e}return Re(a,s=>s[0]=0),await vt(r,!1),o!=null?{data:o}:void 0}function J(e,t=302){let n,o;typeof t=="number"?n={status:t}:({revalidate:o,...n}=t,typeof n.status>"u"&&(n.status=302));const r=new Headers(n.headers);return r.set("Location",e),o&&r.set("X-Revalidate",o.toString()),new Response(null,{...n,headers:r})}function Et(e={}){let t,n=!1;const o=s=>{if(t&&t!==s)throw new Error("Context conflict")};let r;if(e.asyncContext){const s=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;s?r=new s:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(r&&t===void 0){const s=r.getStore();if(s!==void 0)return s}return t};return{use:()=>{const s=a();if(s===void 0)throw new Error("Context is not available");return s},tryUse:()=>a(),set:(s,c)=>{c||o(s),t=s,n=!0},unset:()=>{t=void 0,n=!1},call:(s,c)=>{o(s),t=s;try{return r?r.run(s,c):c()}finally{n||(t=void 0)}},async callAsync(s,c){t=s;const u=()=>{t=s},l=()=>t===s?u:void 0;se.add(l);try{const i=r?r.run(s,c):c();return n||(t=void 0),await i}finally{se.delete(l)}}}}function _t(e={}){const t={};return{get(n,o={}){return t[n]||(t[n]=Et({...e,...o})),t[n],t[n]}}}const j=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},re="__unctx__",Pt=j[re]||(j[re]=_t()),Ot=(e,t={})=>Pt.get(e,t),oe="__unctx_async_handlers__",se=j[oe]||(j[oe]=new Set);function Ht(e){let t;const n=xe(e),o={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...o,body:e.node.req.body}):new Request(n,{...o,get body(){return t||(t=Bt(e),t)}})}function Tt(e){return e.web??={request:Ht(e),url:xe(e)},e.web.request}function $t(){return Nt()}const Se=Symbol("$HTTPEvent");function Lt(e){return typeof e=="object"&&(e instanceof K||e?.[Se]instanceof K||e?.__is_event__===!0)}function R(e){return function(...t){let n=t[0];if(Lt(n))t[0]=n instanceof K||n.__is_event__?n:n[Se];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=$t(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const xe=R(We),qt=R(Fe),ae=R(ke),ie=R(je),kt=R(Ue),I=R(Be),ce=R(Me),It=R(De),Ft=R(Ke),ln=R(Te),jt=R($e),Ut=R(Le),Wt=R(qe),fn=R(Ie),Bt=R(Xe),Mt=R(Ne),Dt=R(Tt);function Kt(){return Ot("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ze})}function Nt(){return Kt().use().event}const D=Symbol("fetchEvent");function Xt(e){return{request:Dt(e),response:Jt(e),clientAddress:qt(e),locals:{},nativeEvent:e}}function zt(e){return{...e}}function hn(e){if(!e[D]){const t=Xt(e);e[D]=t}return e[D]}class Gt{event;constructor(t){this.event=t}get(t){const n=ce(this.event,t);return Array.isArray(n)?n.join(", "):n||null}has(t){return this.get(t)!==void 0}set(t,n){return It(this.event,t,n)}delete(t){return Mt(this.event,t)}append(t,n){Ft(this.event,t,n)}getSetCookie(){const t=ce(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(I(this.event)).forEach(([n,o])=>t(Array.isArray(o)?o.join(", "):o,n,this))}entries(){return Object.entries(I(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(I(this.event))[Symbol.iterator]()}values(){return Object.values(I(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Jt(e){return{get status(){return ie(e)},set status(t){ae(e,t)},get statusText(){return kt(e)},set statusText(t){ae(e,ie(),t)},headers:new Gt(e)}}function Q(e,t,n){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const o="";return new Proxy(e,{get(r,a,s){if(a==="url")return`${o}/_server?id=${encodeURIComponent(t)}&name=${encodeURIComponent(n)}`;if(a==="GET")return s},apply(r,a,s){const c=P();if(!c)throw new Error("Cannot call server function outside of a request");const u=zt(c);return u.locals.serverFunctionMeta={id:t+"#"+n},u.serverOnly=!0,He(u,()=>e.apply(a,s))}})}const Qt=Q(async e=>(Ut("auth_token","test_token"),J("/")),"c_4631","logInServer"),Vt=Q(async e=>(Wt("auth_token"),J("/login")),"c_4631","logOutServer"),Yt=Q(async()=>{const e=jt("auth_token");return console.log(e),e?2e7:J("/login")},"c_4631","getUserProfileServer"),dn=ve(Qt),pn=ve(Vt),gn=U(Yt,"userProfile");export{ct as R,an as a,at as b,dt as c,cn as d,ut as e,ne as f,pt as g,Ze as h,gn as i,jt as j,on as k,Ut as l,pe as m,sn as n,hn as o,ln as p,ae as q,fn as r,de as s,pn as t,un as u,dn as v};
